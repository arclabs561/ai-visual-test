#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Pre-push checks..."

# Run full test suite before pushing
echo "Running full test suite..."
npm test || {
  echo "‚ùå Tests failed. Push aborted."
  exit 1
}

# Check if package.json version was updated (if package.json changed)
if git diff HEAD@{1} HEAD --name-only | grep -q "package.json"; then
  OLD_VERSION=$(git show HEAD@{1}:package.json 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/' || echo "")
  NEW_VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
  
  if [ -n "$OLD_VERSION" ] && [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
    echo "‚ö†Ô∏è  Warning: package.json changed but version was not updated"
    echo "   Old version: $OLD_VERSION"
    echo "   New version: $NEW_VERSION"
  fi
fi

# Check for large files that shouldn't be committed
echo "Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'test -f {} && du -h {}' 2>/dev/null | awk '$1 ~ /[0-9]+[MG]/ {print $2}' || true)

if [ -n "$LARGE_FILES" ]; then
  echo "‚ö†Ô∏è  Warning: Large files detected:"
  echo "$LARGE_FILES" | while read file; do
    if [ -n "$file" ]; then
      SIZE=$(du -h "$file" 2>/dev/null | cut -f1)
      echo "   - $file ($SIZE)"
    fi
  done
  echo "   Consider using Git LFS for large files"
fi

# Warn if pushing to main/master without a PR
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "‚ö†Ô∏è  Warning: Pushing directly to $CURRENT_BRANCH branch"
  echo "   Consider using a feature branch and opening a PR instead"
fi

echo "‚úÖ Pre-push checks passed"

